Return-Path: <linux-btrfs-owner@vger.kernel.org>
X-Original-To: lists+linux-btrfs@lfdr.de
Delivered-To: lists+linux-btrfs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 54E0543AF50
	for <lists+linux-btrfs@lfdr.de>; Tue, 26 Oct 2021 11:44:04 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S234969AbhJZJqM (ORCPT <rfc822;lists+linux-btrfs@lfdr.de>);
        Tue, 26 Oct 2021 05:46:12 -0400
Received: from mail.kernel.org ([198.145.29.99]:52830 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S234436AbhJZJqM (ORCPT <rfc822;linux-btrfs@vger.kernel.org>);
        Tue, 26 Oct 2021 05:46:12 -0400
Received: by mail.kernel.org (Postfix) with ESMTPSA id 8813E6108B
        for <linux-btrfs@vger.kernel.org>; Tue, 26 Oct 2021 09:43:48 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1635241428;
        bh=mVjnUx7/86c4I7duPSeF/OPh7YP5IumHjBn7KubrRL8=;
        h=References:In-Reply-To:From:Date:Subject:To:From;
        b=rKEAKBj3ackuYfL13mXxySqU5rRdlu1GvpnyYIlNSkgyZwhBYB5coKiA51rbJYPot
         ISeg04QcEXHQame+CFGCJjxcIdX3ZSM2jw9DbxZ8x2GTDqBT7lfQttaNCQXw1Hqf+l
         8gWu6BhCcIhEfg8Wuuwci6RexmRbwJQayLsu7OuvAh+RxSthSvDEE0YcFSnU6J05IJ
         hk6an2eGoIsTiJvEPrzMynw0CdGcDxU1bI1ezdE09oU9zucDleVbM2U06nCuNPoyb2
         VtrKiAwvicLELK1V4072Prw3wYOtDRcjvCQJDkwGb2qGveX29w6ksTwURC7iQFua67
         I86uRJqw9DbVA==
Received: by mail-qt1-f172.google.com with SMTP id z24so12895016qtv.9
        for <linux-btrfs@vger.kernel.org>; Tue, 26 Oct 2021 02:43:48 -0700 (PDT)
X-Gm-Message-State: AOAM533YZ+HAoaf1U3Aw2srmQFGp2TfxtUIrWEA4QYGIe403263trrPo
        BY+nGgF8304UhfC1UfgvY8jk/4Lphlk/oXx1d7I=
X-Google-Smtp-Source: ABdhPJy3B8TAuAhOzvAW1Pq0zKBiKiYkkCc4+TeAO8iZ2cUoKQ8M7+dM5JO/0TTCXzvE6XRUZOI2Hyn97Rs8NM8SygM=
X-Received: by 2002:a05:622a:1807:: with SMTP id t7mr23765103qtc.140.1635241427691;
 Tue, 26 Oct 2021 02:43:47 -0700 (PDT)
MIME-Version: 1.0
References: <cover.1635155473.git.fdmanana@suse.com> <cover.1635178668.git.fdmanana@suse.com>
 <20211025195520.GT20319@twin.jikos.cz>
In-Reply-To: <20211025195520.GT20319@twin.jikos.cz>
From:   Filipe Manana <fdmanana@kernel.org>
Date:   Tue, 26 Oct 2021 10:43:11 +0100
X-Gmail-Original-Message-ID: <CAL3q7H54A=Bw_us_ah_1veZ9jZ5JEUqE7=r00x+hE7zpQZ9NBg@mail.gmail.com>
Message-ID: <CAL3q7H54A=Bw_us_ah_1veZ9jZ5JEUqE7=r00x+hE7zpQZ9NBg@mail.gmail.com>
Subject: Re: [PATCH v2 0/6] btrfs: speedup directory logging/fsync by copying
 index keys only
To:     David Sterba <dsterba@suse.cz>,
        Filipe Manana <fdmanana@kernel.org>,
        linux-btrfs <linux-btrfs@vger.kernel.org>,
        Josef Bacik <josef@toxicpanda.com>,
        Filipe Manana <fdmanana@suse.com>
Content-Type: text/plain; charset="UTF-8"
Precedence: bulk
List-ID: <linux-btrfs.vger.kernel.org>
X-Mailing-List: linux-btrfs@vger.kernel.org

On Mon, Oct 25, 2021 at 8:55 PM David Sterba <dsterba@suse.cz> wrote:
>
> On Mon, Oct 25, 2021 at 05:31:48PM +0100, fdmanana@kernel.org wrote:
> > From: Filipe Manana <fdmanana@suse.com>
> >
> > This patchset reworks directory logging to make it copy only the dir index
> > keys, instead of copying both dir index keys and dir item keys, as both have
> > the same type of information. This reduces the amount of logged metadata by
> > about half, and therefore we do about half of the cpu bound work, half of
> > the IO and use less log tree space (except for very small directories).
> >
> > This will allow other optimizations to build on top, some of which are only
> > possible after this change, while others become easier and less cumbersome
> > to implement after this change. Performance tests are in the changelog of
> > patch 5/6. Patch 6/6 only removes code that deals with dir item keys when
> > replaying directory deletions and it could have been squashed into patch
> > 5/6, but since that one is already large and works without 6/6, I opted
> > to make it separate to make it easier to review.
> >
> > Also, after this change we are still able to correctly replay a log tree
> > generated by an old kernel, and an old kernel is also able to correctly
> > replay a log tree generated by a kernel that has this patchset applied.
> >
> > I'm sending this close to the 5.16 merge window, but my intention is to
> > have it only for the next merge window (5.17).
> >
> > V2: Updated changelog of patch 5/6 to make it more clear why backward
> >     and forward compatibility are guaranteed.
> >
> > Filipe Manana (6):
> >   btrfs: remove root argument from drop_one_dir_item()
> >   btrfs: remove root argument from btrfs_unlink_inode()
> >   btrfs: remove root argument from add_link()
> >   btrfs: remove root argument from check_item_in_log()
>
> If you want, I can add the first 4 patches to misc-next still queued for
> 5.16 pull next week, it's fairly trivial and you won't have to refresh
> the patches. For preparatory patches like this it's free pass even
> before merge window.

I'm fine with either way.
Thanks.
