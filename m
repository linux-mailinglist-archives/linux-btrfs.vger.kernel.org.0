Return-Path: <linux-btrfs-owner@vger.kernel.org>
X-Original-To: lists+linux-btrfs@lfdr.de
Delivered-To: lists+linux-btrfs@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id BE51843A38A
	for <lists+linux-btrfs@lfdr.de>; Mon, 25 Oct 2021 21:58:12 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S240328AbhJYUAR (ORCPT <rfc822;lists+linux-btrfs@lfdr.de>);
        Mon, 25 Oct 2021 16:00:17 -0400
Received: from smtp-out1.suse.de ([195.135.220.28]:48552 "EHLO
        smtp-out1.suse.de" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239879AbhJYT6P (ORCPT
        <rfc822;linux-btrfs@vger.kernel.org>);
        Mon, 25 Oct 2021 15:58:15 -0400
Received: from relay2.suse.de (relay2.suse.de [149.44.160.134])
        by smtp-out1.suse.de (Postfix) with ESMTP id D412E2195B;
        Mon, 25 Oct 2021 19:55:51 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.cz; s=susede2_rsa;
        t=1635191751;
        h=from:from:reply-to:reply-to:date:date:message-id:message-id:to:to:
         cc:cc:mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=Sa8MpNppTvfgvojy2SdkYBkvqZg27nsiRNt7nZ8ytXg=;
        b=WejOt2shovIc9wDaGAejSD0mY6JGo2R4837kZdUCvKNS45s+uvuEVEo7vEF+djy+0+DEoD
        /pXZvHiZPAFug0RkXfRocwUBaChFVKAdWocv4A1OCdsvBmDYKN0yj6LrLZodhrUNy450e+
        mkMOcr/x3OWKSL0SHaiGFEtvMDZuQ0U=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.cz;
        s=susede2_ed25519; t=1635191751;
        h=from:from:reply-to:reply-to:date:date:message-id:message-id:to:to:
         cc:cc:mime-version:mime-version:content-type:content-type:
         in-reply-to:in-reply-to:references:references;
        bh=Sa8MpNppTvfgvojy2SdkYBkvqZg27nsiRNt7nZ8ytXg=;
        b=6iPveLH3PsjLENQtx9Gned3NnVg+tgny4KBp7JQjA1/9jPVklkWpQ6Pe+YYMMFTHSFyCSg
        qCYQtG6RWvu8xBAA==
Received: from ds.suse.cz (ds.suse.cz [10.100.12.205])
        by relay2.suse.de (Postfix) with ESMTP id CA951A3BCE;
        Mon, 25 Oct 2021 19:55:51 +0000 (UTC)
Received: by ds.suse.cz (Postfix, from userid 10065)
        id CEC41DA7A9; Mon, 25 Oct 2021 21:55:20 +0200 (CEST)
Date:   Mon, 25 Oct 2021 21:55:20 +0200
From:   David Sterba <dsterba@suse.cz>
To:     fdmanana@kernel.org
Cc:     linux-btrfs@vger.kernel.org, josef@toxicpanda.com,
        Filipe Manana <fdmanana@suse.com>
Subject: Re: [PATCH v2 0/6] btrfs: speedup directory logging/fsync by copying
 index keys only
Message-ID: <20211025195520.GT20319@twin.jikos.cz>
Reply-To: dsterba@suse.cz
Mail-Followup-To: dsterba@suse.cz, fdmanana@kernel.org,
        linux-btrfs@vger.kernel.org, josef@toxicpanda.com,
        Filipe Manana <fdmanana@suse.com>
References: <cover.1635155473.git.fdmanana@suse.com>
 <cover.1635178668.git.fdmanana@suse.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <cover.1635178668.git.fdmanana@suse.com>
User-Agent: Mutt/1.5.23.1-rc1 (2014-03-12)
Precedence: bulk
List-ID: <linux-btrfs.vger.kernel.org>
X-Mailing-List: linux-btrfs@vger.kernel.org

On Mon, Oct 25, 2021 at 05:31:48PM +0100, fdmanana@kernel.org wrote:
> From: Filipe Manana <fdmanana@suse.com>
> 
> This patchset reworks directory logging to make it copy only the dir index
> keys, instead of copying both dir index keys and dir item keys, as both have
> the same type of information. This reduces the amount of logged metadata by
> about half, and therefore we do about half of the cpu bound work, half of
> the IO and use less log tree space (except for very small directories).
> 
> This will allow other optimizations to build on top, some of which are only
> possible after this change, while others become easier and less cumbersome
> to implement after this change. Performance tests are in the changelog of
> patch 5/6. Patch 6/6 only removes code that deals with dir item keys when
> replaying directory deletions and it could have been squashed into patch
> 5/6, but since that one is already large and works without 6/6, I opted
> to make it separate to make it easier to review.
> 
> Also, after this change we are still able to correctly replay a log tree
> generated by an old kernel, and an old kernel is also able to correctly
> replay a log tree generated by a kernel that has this patchset applied.
> 
> I'm sending this close to the 5.16 merge window, but my intention is to
> have it only for the next merge window (5.17).
> 
> V2: Updated changelog of patch 5/6 to make it more clear why backward
>     and forward compatibility are guaranteed.
> 
> Filipe Manana (6):
>   btrfs: remove root argument from drop_one_dir_item()
>   btrfs: remove root argument from btrfs_unlink_inode()
>   btrfs: remove root argument from add_link()
>   btrfs: remove root argument from check_item_in_log()

If you want, I can add the first 4 patches to misc-next still queued for
5.16 pull next week, it's fairly trivial and you won't have to refresh
the patches. For preparatory patches like this it's free pass even
before merge window.
